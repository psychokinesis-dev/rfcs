- 开始日期： 2016-03-08

# 概述

使用 DHT、 HTTP/2 等协议实现 Web 服务器之间的互相代理，进而支持可以访问其中任何一台 Web 服务器的浏览器都可直接访问位于其他 Web 服务器上的内容，大致原理如下：
![](http2_reverse_proxy.png)

# 目的

通过反向代理让数据回归客户端自身，去除**数据中心化**。

# 实现细节

基于现有的 HTTP 库，需要实现以下功能：

## P2P
不同于传统的 HTTP 反向代理只实现单向的代理，此特性需要支持双向的代理。任一节点收到请求后获得其请求的真实主机名，然后通过查询 DHT 获得主机信息，最后与其建立连接后自身充当代理的角色。将主机名到真实地址（ IP:PORT ）的路由信息存于 DHT 中这一过程需要定期不断地执行以保证最新。

## 公网代理
此特性允许其他节点将主机名映射到自己的地址，进而外来请求可以通过公网代理访问到内网的节点。而当节点处于内网中时需要与公网中至少一个节点保持 HTTP/2 长连接。

内网节点与公网节点之间的 HTTP/2 长连接通过如下方法建立：首先公网节点运行一个普通的 TCP 服务器，然后内网节点连接此 TCP 服务器，连接建立之后公网节点通过此连接发送 HTTP/2 请求，内网节点从该连接接收 HTTP/2 请求。

## URL 路径重定向
注意这个特性需要保留 URL 第一段路径为内部使用。

### 域名重定向
通过 URL 第一段路径作为域名进行定位的方法。比如对于 URL ： http://127.0.0.1:8181/example.com/test ，即需要将此请求定位到域名 example.com 在 DHT 中指向的地址。
此特性用于获取实时在线的资源。

### 资源重定向
将 URL 第一段路径设置为 offline ，其后一段为请求的资源 id 。比如对于 URL ： http://127.0.0.1:8181/offline/1 ，即根据资源 id 1 从资源文件元数据存储中获取文件分片信息，然后再依次获取文件分片返回给请求节点。
此特性用于通过普通的 HTTP 请求直接获取分散在 [P2P 文件存储](p2p-file-store.md) 中的资源。

### 资源分片重定向
将 URL 第一段路径设置为 chunks ，其后一段为请求的分片 id 。比如对于 URL ： http://127.0.0.1:8181/chunks/4e96267a3ee3196770d47c4a351668e9 ， 即根据资源分片 id 4e96267a3ee3196770d47c4a351668e9 和在线节点信息缓存通过特定算法获取到资源分片所在的节点信息，然后请求对应节点将分片数据中转返回给请求节点。
此特性用于 [P2P 文件存储](p2p-file-store.md) 网络中节点资源的构建，网络中每个节点会根据特定的算法获取到属于自己的分片数据。

## 处理外部 HTTP 客户端请求
此特性与传统 Web 服务器处理请求的方法一致。

# 类似的设计
[pangolin](https://github.com/qgy18/pangolin) 实现了一个很简单的 HTTP/2 反向代理，仅包括公网代理的功能。

# 未解决的问题
## 主机名的安全性问题
主机名缺乏所有权，存在被冒用的问题，将来可以考虑使用区块链技术解决。
